% by Yasuhiro Fujii <http://mimosa-pudica.net>, under CC BY 4.0.
% vim: textwidth=120
\documentclass{ltjsarticle}
\usepackage{amsmath}
\usepackage{newunicodechar}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{luatexja}

% \block{macro}{
	\newunicodechar{Ω}{\Omega}
	\newunicodechar{α}{\alpha}
	\newunicodechar{γ}{\gamma}
	\newunicodechar{δ}{\delta}
	\newunicodechar{ε}{\epsilon}
	\newunicodechar{θ}{\theta}
	\newunicodechar{π}{\pi}
	\newunicodechar{ω}{\omega}
	\newunicodechar{∂}{\partial}
	\newunicodechar{∇}{\nabla}
	\newunicodechar{√}{\sqrt}
	\newunicodechar{∞}{\infty}
	\newunicodechar{∫}{\int}
	\newunicodechar{↑}{\uparrow}
	\newunicodechar{↓}{\downarrow}
	\newunicodechar{→}{\rightarrow}
	\newunicodechar{←}{\leftarrow}

	\long\def\block#1#2{\begin{#1}#2\end{#1}}
	\def\d{\mathrm{d}}
	\def\L{\left}
	\def\R{\right}

	\def\ks{{k_{\mathrm s}}}
	\def\ka{{k_{\mathrm a}}}
	\def\vx{\vec{x}}
	\def\vω{\vec{ω}}
% }

\block{document}{
	\title{散乱・吸収のある半無限一様媒質による反射率の近似}
	\author{\small ふじい やすひろ {\tt <http://mimosa-pudica.net>}}
	\date{\empty}
	\maketitle

	かきかけ。

	\block{align}{
		\ks &\, [1 / \mathrm{m}] && \text{: 散乱係数} \\
		\ka &\, [1 / \mathrm{m}] && \text{: 吸収係数} \\
		I(t, \vx, \vω) &\, [\mathrm{W} / \mathrm{m}^2 \cdot \mathrm{sr}] && \text{: 位置 $ \vx $, 方向 $ \vω $ の放射輝度} \\
		\vec{n}(\vω) &\, && \text{: $ \vω $ 方向の単位ベクトル}
	}

	散乱・吸収のある半無限一様媒質による反射率の近似式を求める。ここでの反射率は、媒質へ入射する放射発散度
	($ = ∫ \d Ω(\vω) \, (\vec{n}(\vω) \cdot \vec{N}) I(\vω) $ ; $ \vec{N} $ は境界面の法線ベクトル) と出射する放射発散度
	の比と定義する。

	$ z = 0 $ を境界として $ z < 0 $ の空間に一様な媒質が存在し、 $ z > 0 $ の空間は真空である状況を考える。以下、この状
	況下で放射伝達方程式 (Radiative transfer equation; RTE) の近似解を求め、媒質への入射量と出射量の比から反射率を計算す
	る。

	等方散乱、一様媒質下での RTE は次式で表される。
	\block{equation}{
		\frac{∂ I(t, \vx, \vω)}{∂ t} + \vec{n}(\vω) \cdot ∇ I(t, \vx, \vω) =
		-(\ks + \ka) I(t, \vx, \vω) + \frac{\ks}{4 π} ∫ \d Ω(\vω') \, I(t, \vx, \vω') \,.
	}

	$ I(\cdot) $ は $ t, x, y $ 方向について一様なので、 $ θ $ を $ +z $ となす角度として、
	\block{equation}{
		\cos θ \frac{∂ I(z, θ)}{∂ z} =
		-(\ks + \ka) I(z, θ) + \frac{\ks}{2} ∫_0^π \d θ' \sin θ' \, I(z, θ') \,, \label{rte_z}
	}
	と簡略化される。

	$ I(\cdot) $ が立体角について $ z^-, z^+ $ 半球上でそれぞれ一様に近いと仮定し、次のように展開する。 $ h(\cdot) $ を
	階段関数として、
	\block{equation}{
		I(z, θ) = h \L(\frac{π}{2} - θ \R) I_↑(z) + h \L( θ - \frac{π}{2} \R) I_↓(z) + ε(z, θ) \,,
		\  |ε|, \L| \frac{∂ ε}{∂ z} \R| \ll |I_↑|, |I_↓|  \,. \label{i_approx}
	}

	(\ref{rte_z}) に (\ref{i_approx}) を代入し、両辺を $ z^+ $ 半球上で一様に立体角積分
	( $ ∫_0^{π/2} \d θ \sin θ $ ) すると、
	\block{equation}{
		+\frac{1}{2} \frac{\d I_↑}{\d z} = -(\ks + \ka) I_↑ + \frac{\ks}{2} (I_↑ + I_↓) + O(ε) \,. \label{upper_int}
	}
 
	同様に $ z^- $ 半球で積分 ( $ ∫_{π/2}^π \d θ \sin θ $ ) すると、
	\block{equation}{
		-\frac{1}{2} \frac{\d I_↓}{\d z} = -(\ks + \ka) I_↓ + \frac{\ks}{2} (I_↑ + I_↓) + O(ε) \,. \label{lower_int}
	}

	この計算は次の操作を行ったことに相当している。単位球面上で定義される実関数のなす空間に対し、内積を
	$ \langle f, g \rangle := ∫ \d Ω(\vω) \, f(\vω) g(\vω) $ で導入し、それぞれ $ z^+, z^- $ 半球のみで一様な値を持つ関
	数 2 つを基底として含む直交関数系を用意する。この直交関数系で $ I(\cdot) $ を立体角について展開し、係数について成り
	立つ方程式が (\ref{upper_int}), (\ref{lower_int}) である。
 
	さて、 $ ε $ を無視して (\ref{upper_int}), (\ref{lower_int}) を連立させて解くと、一般解は $ \ka \ne 0 $ のとき
	$ A, B $ を任意の定数として、
	\block{align}{
		I_↑(z) &= A (1 + P) e^{-α z} + B (1 - P) e^{+α z} \\
		I_↓(z) &= A (1 - P) e^{-α z} - B (1 + P) e^{+α z} \,,
	}
	\block{align}{
		α &= 2 √{\ka (\ks + \ka)} \\
		P &= √{\frac{\ka}{\ks + \ka}} \,.
	}

	次に境界条件を考える。真空部分について $ I_↑(z), I_↓(z) $ は一定であり、 $ I_↓ $ が媒質への入射、 $ I_↑ $ が出射に対
	応している。媒質部分については $ z = -∞ $ からの入射がないとして、境界条件
	\block{align}{
		{} & \lim_{z → -∞} I_↑(z) = 0 \,,
	}
	が課される。また、屈折率が変わらないので、 $ z = 0 $ の境界では単純に $ I_↑(z), I_↓(z) $ が連続であることが条件とな
	る。

	以上より、 $ z = 0 $ 平面から媒質へ入射した光の反射率は、
	\block{align}{
		R = \frac{I_↑(0)}{I_↓(0)} = \frac{1 - P}{1 + P} \,.
	}

	半無限の媒質下で反射率は空間スケールに依存しないため、反射率は $ \ks $ と $ \ka $ の比のみで決まる。上式ははこの性質
	を満たし、かつ $ \ks \ll \ka \Rightarrow R → 0 ,\, \ks \gg \ka \Rightarrow R → 1 $ となり、定性的に良い振る舞いをす
	る近似になっている (この性質が成り立つかは、実は基底の取り方に依存している。例えば球面調和関数の低次を用いるとこの性
	質は成り立たない) 。残念ながら $ \ks \simeq \ka $ での値は正しい値と 10\% ほどずれていて、定量的にはそれほど良い近似
	ではない。

	精度を改善するためこの式に少し修正を加え、係数をモンテカルロ法による数値計算の結果から決定する。
	\block{equation}{
		\tilde{R} = \frac{1 - P}{1 + γ P} \,.
	}

	何を最小化するかに依って多少変わってくるが、 $ γ = 1.4 $ で平均絶対誤差 $ 2 \times {10}^{-3} $, 平均相対誤差 1\% 未
	満となる。ちなみに分母を $ 1 + γ P + δ P^2 $ の形にすることで、もう一桁ほど良い近似式を作ることも可能である。

	この式は逆変換、つまり反射率から散乱・吸収係数を求める式もシンプルな形をしている。これは CG ソフトウェアなどで、反射
	色から媒質の散乱・吸収係数を設定する場合などに有用である。反射率 $ R $ と減衰係数 $ k := \ks + \ka $ が与えられたと
	き、上式を $ \ks, \ka $ について解くと、
	\block{align}{
		\ka &= k {\L( \frac{1 - \tilde{R}}{1 + γ \tilde{R}} \R) }^2 \\
		\ks &= k - \ka \,.
	}

	\includegraphics{../build/plot.pdf}
}
